name: Build_Release
on:
  # See the documentation for more intricate event dispatch here:
  # https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions#on
  push:
    branches:
    - "master"
jobs:
  build:
    name: Build & Release
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Build Docker Image
      run: ./build-in-docker.sh
    - uses: "marvinpinto/action-automatic-releases@latest"
      with: 
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        title: "Dev Build"
        automatic_release_tag: "latest"
        files: out/*
  
  push_to_registry:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata (ipfs-mexport-builder)
        id: meta
        uses: docker/metadata-action@98669ae865ea3cffbcbaa878cf57c20bbf1c6c38
        with:
          images: mg98/ipfs-mexport-builder

      - name: Build and push Docker image (ipfs-mexport-builder)
        uses: docker/build-push-action@ad44023a93711e3deb337508980b4b5e9bcdc5dc
        with:
          context: .
          file: Dockerfile.builder
          push: true

      - name: Extract metadata (kubo-mexport)
        id: meta
        uses: docker/metadata-action@98669ae865ea3cffbcbaa878cf57c20bbf1c6c38
        with:
          images: mg98/kubo-mexport

      - name: Build and push Docker image (kubo-mexport)
        uses: docker/build-push-action@ad44023a93711e3deb337508980b4b5e9bcdc5dc
        with:
          context: .
          file: Dockerfile.kubo
          push: true
